study("TD Sequential Test", overlay=true)
transp = input(0)
Numbers = input(true)
SR = input(true)
Barcolor = input(true)

// Sequential Counters
TD = close > close[4] ? nz(TD[1]) + 1 : 0
TS = close < close[4] ? nz(TS[1]) + 1 : 0

TDUp = TD - valuewhen(TD < TD[1], TD, 1)
TDDn = TS - valuewhen(TS < TS[1], TS, 1)

plotshape(Numbers ? (TDUp == 8 ? true : na) : na, style=shape.triangledown, text="8", color=white, location=location.abovebar, transp=transp)
plotshape(Numbers ? (TDUp == 9 ? true : na) : na, style=shape.triangledown, text="9", color=white, location=location.abovebar, transp=transp)
plotshape(Numbers ? (TDDn == 8 ? true : na) : na, style=shape.triangleup, text="8", color=white, location=location.belowbar, transp=transp)
plotshape(Numbers ? (TDDn == 9 ? true : na) : na, style=shape.triangleup, text="9", color=white, location=location.belowbar, transp=transp)

// Setup Logic
priceflip_sell = barssince(close < close[4])
sellsetup = close > close[4] and priceflip_sell
sell = sellsetup and barssince(priceflip_sell != 9)

priceflip_buy = barssince(close > close[4])
buysetup = close < close[4] and priceflip_buy
buy = buysetup and barssince(priceflip_buy != 9)

// Overshoot Conditions - Adjusted to Keep Showing Until the Pattern Resets
sell_overshoot_active = barssince(sellsetup) >= 9 and barssince(sellsetup) < 15
buy_overshoot_active = barssince(buysetup) >= 9 and barssince(buysetup) < 15

// Plots for Support/Resistance Levels
TDbuyh = valuewhen(buy, high, 0)
TDbuyl = valuewhen(buy, low, 0)
TDsellh = valuewhen(sell, high, 0)
TDselll = valuewhen(sell, low, 0)

plot(SR ? (TDbuyh ? TDbuyl : na) : na, style=circles, linewidth=1, color=red)
plot(SR ? (TDselll ? TDsellh : na) : na, style=circles, linewidth=1, color=lime)

// Bar Coloring Logic with Overshoot Active Until Reset
barcolor(Barcolor ? (
    sell ? #FF5252 : buy ? #4CAF50 :
    sell_overshoot_active ? #f5e072 :
    buy_overshoot_active ? #f5e072 : na) : na)

